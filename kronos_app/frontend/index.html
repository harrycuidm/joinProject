<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kronos A股预测仪表板</title>
    <style>
      body {
        font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f6f8;
        color: #1f2933;
      }
      header {
        background: linear-gradient(120deg, #0d47a1, #1976d2);
        color: #fff;
        padding: 24px;
        text-align: center;
      }
      main {
        max-width: 960px;
        margin: 24px auto;
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }
      label {
        display: block;
        margin-top: 16px;
        font-weight: 600;
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border: 1px solid #cfd8dc;
        border-radius: 8px;
        font-size: 16px;
      }
      button {
        margin-top: 24px;
        background: #1976d2;
        color: #fff;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
      }
      button:disabled {
        background: #90a4ae;
        cursor: not-allowed;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 24px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
      }
      th {
        background: #f1f5f9;
      }
      .error {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #fddede;
        color: #c53030;
      }
      footer {
        margin-top: 24px;
        text-align: center;
        color: #546e7a;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Kronos 模型 A股预测平台</h1>
      <p>输入股票代码和预测天数，获取未来涨跌幅预测与历史验证结果。</p>
    </header>
    <main>
      <section>
        <label for="ticker">股票代码（示例：600519.SH）</label>
        <input id="ticker" type="text" placeholder="请输入完整证券代码" />

        <label for="horizons">预测天数（以逗号分隔，如 1,3,5,10）</label>
        <input id="horizons" type="text" value="1,3,5,10" />

        <label for="anchor">评估锚定日期（可选，格式 YYYY-MM-DD）</label>
        <input id="anchor" type="date" />

        <label>
          <input id="runEvaluation" type="checkbox" checked />
          启用历史准确率评估
        </label>

        <button id="submitBtn">开始预测</button>
        <div id="error" class="error" style="display: none"></div>
      </section>

      <section id="result" style="display: none">
        <h2>预测结果</h2>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>预测涨跌幅</th>
              <th>模型置信度</th>
            </tr>
          </thead>
          <tbody id="predictionBody"></tbody>
        </table>

        <h2>准确率评估</h2>
        <table>
          <thead>
            <tr>
              <th>预测天数</th>
              <th>准确率</th>
              <th>样本数</th>
            </tr>
          </thead>
          <tbody id="evaluationBody"></tbody>
        </table>
      </section>
    </main>
    <footer>
      数据来源：Tushare Pro。请确保已在服务器端配置真实数据访问凭证。
    </footer>

    <script>
      const apiBase = (window.API_BASE || '') + '/api';
      const submitBtn = document.getElementById('submitBtn');
      const errorBox = document.getElementById('error');
      const resultSection = document.getElementById('result');
      const predictionBody = document.getElementById('predictionBody');
      const evaluationBody = document.getElementById('evaluationBody');

      function resetResult() {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
        predictionBody.innerHTML = '';
        evaluationBody.innerHTML = '';
        resultSection.style.display = 'none';
      }

      submitBtn.addEventListener('click', async () => {
        resetResult();
        submitBtn.disabled = true;
        submitBtn.textContent = '预测中，请稍候...';
        try {
          const ticker = document.getElementById('ticker').value.trim();
          const horizonsInput = document.getElementById('horizons').value.trim();
          const anchor = document.getElementById('anchor').value;
          const runEvaluation = document.getElementById('runEvaluation').checked;

          if (!ticker) {
            throw new Error('请填写股票代码');
          }

          const payload = {
            ticker,
            horizons: horizonsInput ? horizonsInput.split(',').map((v) => parseInt(v.trim(), 10)) : [],
            run_evaluation: runEvaluation,
          };
          if (anchor) {
            payload.evaluation_anchor = anchor;
          }

          const response = await fetch(`${apiBase}/predict`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const detail = await response.json();
            throw new Error(detail.detail || '服务调用失败');
          }

          const data = await response.json();
          const prediction = data.prediction;
          const evaluation = data.evaluation || [];

          Object.entries(prediction.daily_changes)
            .sort(([a], [b]) => new Date(a) - new Date(b))
            .forEach(([dateStr, info]) => {
              const row = document.createElement('tr');
              const change = (info.return * 100).toFixed(2) + '%';
              const prob = info.probability ? (info.probability * 100).toFixed(1) + '%' : '—';
              row.innerHTML = `<td>${dateStr}</td><td>${change}</td><td>${prob}</td>`;
              predictionBody.appendChild(row);
            });

          evaluation.forEach((item) => {
            const row = document.createElement('tr');
            const accuracy = (item.accuracy * 100).toFixed(2) + '%';
            row.innerHTML = `<td>${item.horizon_days} 天</td><td>${accuracy}</td><td>${item.total_cases}</td>`;
            evaluationBody.appendChild(row);
          });

          resultSection.style.display = 'block';
        } catch (error) {
          errorBox.style.display = 'block';
          errorBox.textContent = error.message || String(error);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = '开始预测';
        }
      });
    </script>
  </body>
</html>
